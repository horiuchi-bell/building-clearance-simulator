# 建築限界シミュレーター V22 完成版

## 概要
建築限界シミュレーター V22は、鉄道建築限界の計算と可視化を行うPythonアプリケーションです。
Excel「OIRANシュミレーター（修正）20231215.xlsx」の計算方式を完全再現し、
日本語フォント対応により文字化けを完全解消した最終完成版です。

## 主な特徴

### ✅ Excel完全準拠の計算エンジン
- **必要離れ計算**: Excelの複雑な高さ範囲判定を完全再現
- **限界余裕/支障量計算**: AG2距離計算とExcel B24セルの計算方式を完全実装
- **曲線拡幅対応**: 拡幅量 = 23000/半径(m) の完全実装
- **カント補正**: 傾斜角度とカント補正の精密計算

### ✅ 高精度座標変換システム（V20-V22改良）
- **Excel準拠変形**: 表示データ計算シート片線のAA,AB列方式を完全再現
- **座標系変換**: Excel座標系（測定点原点）→ アプリ座標系（レール中心原点）
- **極座標回転**: カント角度を考慮した正確な回転変換

### ✅ 日本語フォント完全対応（V22新機能）
- **OS別自動検出**: Windows/macOS/Linux環境に応じた最適フォント選択
- **文字化け防止**: Matplotlibの日本語表示を完全対応
- **フォールバック機能**: フォント設定失敗時の自動代替

### ✅ 直感的なユーザーインターフェース
- **テンキーパッド**: 簡単な数値入力
- **リアルタイム表示**: 入力値に応じた即座のグラフ更新
- **色分け表示**: 支障時は赤、適合時は青で視覚的に判別

## ファイル構成

```
建築限界シミュレーターV22完成版/
├── clearance_app_v22_font_fixed.py    # メインアプリケーション
├── test_v22_font_fix.py              # フォント設定テストスクリプト
├── v22_clearance_test.png           # サンプル出力画像
└── README.md                         # このファイル
```

## 動作環境

### 必須要件
- Python 3.7以上
- tkinter（通常Pythonに同梱）
- matplotlib
- numpy

### 推奨環境
- **Windows**: Python 3.8+ with Meiryo UI/Yu Gothic フォント
- **macOS**: Python 3.8+ with Hiragino Sans フォント  
- **Linux/WSL**: Python 3.8+ with Noto Sans CJK JP フォント

## インストール・実行方法

### 1. 依存パッケージのインストール
```bash
pip install matplotlib numpy
```

### 2. アプリケーションの実行
```bash
python clearance_app_v22_font_fixed.py
```

### 3. フォント設定のテスト（オプション）
```bash
python test_v22_font_fix.py
```

## 使用方法

### 基本操作
1. **測定離れ**: 正の値で左側、負の値で右側を指定
2. **測定高さ**: レール面からの高さをmm単位で入力
3. **カント**: カント量をmm単位で入力（0-150mm推奨）
4. **曲線半径**: 曲線半径をm単位で入力（0は直線）
5. **測定開始**: 計算実行とグラフ表示

### 入力例
- 左側1900mm、高さ3150mm、カント100mm、直線: `1900, 3150, 100, 0`
- 右側2250mm、高さ3550mm、カント120mm、R300m: `-2250, 3550, 120, 300`

## 技術仕様

### 計算精度
- **Excel差異**: 14mm以内（原典Excelとの計算差異）
- **座標精度**: 0.1mm単位
- **角度精度**: 0.000001 radian単位

### 対応する建築限界
- **高さ範囲**: 0mm ～ 5700mm
- **離れ範囲**: ±3000mm（表示範囲は自動調整）
- **カント範囲**: 0mm ～ 200mm
- **曲線半径**: 100m ～ 10000m

### V22の改良点
1. **Matplotlib日本語フォント自動設定**
   - システム環境に応じた適切なフォント自動選択
   - テスト描画による設定確認機能
   - フォント設定失敗時の自動フォールバック

2. **文字化け完全解消**
   - 軸ラベル、タイトル、凡例の日本語正常表示
   - マイナス記号文字化け防止設定
   - ヘッドレス環境での動作対応

3. **V21全機能の維持**
   - 曲線拡幅計算の完全対応
   - 座標系変換の高精度実装
   - Excel計算エンジンの完全再現

## 開発履歴

### V22 (2025-08-03) - 最終完成版
- **日本語フォント完全対応**: OS別フォント自動検出・設定
- **文字化け完全解消**: Matplotlibの日本語表示を完全修正
- **ヘッドレス環境対応**: WSL/Linux環境でのテスト機能追加

### V21 (2025-08-02) - 曲線拡幅修正版
- **曲線拡幅完全対応**: AG2計算に拡幅を正しく反映
- **建築限界内側判定**: 拡幅を考慮した判定機能
- **計算精度向上**: Excel準拠の最高精度実現

### V20 (2025-08-01) - 座標系修正版
- **座標系変換**: Excel測定点原点 → アプリレール中心原点
- **表示位置修正**: 建築限界モデルの正確な位置表示
- **レール中心原点**: 直感的な座標系での表示

## ライセンス
本ソフトウェアは学習・研究目的で開発されました。
商用利用については開発者にお問い合わせください。

## 注意事項
- 実際の鉄道工事での使用は、必ず公式基準との照合を行ってください
- 計算結果の妥当性確認は使用者の責任で行ってください
- WSL環境では日本語フォントが制限される場合があります

## サポート
問題が発生した場合は、以下を確認してください：
1. Python環境とパッケージのバージョン
2. 使用OS環境とフォント設定
3. エラーメッセージの詳細

---

**建築限界シミュレーター V22** - Excel完全準拠・日本語対応完成版  
開発：Claude Code プロジェクト 2025